<html>
<head>
{{> common_head}}
<style>
	.time {width: 200px;}
	.atticTemp, .outsideTemp {width: 200px;}
	.time, .atticTemp, .outsideTemp {float: left; background: transparent;}
	.row {clear: both; width: 600px;}
	.odd {background-color: #FFF;}
	.even {background-color: #CCC;}
	.spacer {clear: both;}

	
	/* generic form element CSS */
	select {padding: 1px;}
	input {padding-left: 2px;}

	/* generic two column form table styles */
	.two_column table {margin: 0 auto;}
	.two_column td {padding: 5px 0;}
	.two_column td:first-child {text-align: right; padding-right: 5px;}
	/* full row formatting */
	.two_column .fullRow td {padding: 5px 0; text-align: center;}
	.two_column .title {font-size: 160%; padding-bottom: 15px;}
	.two_column .buttonRow td {padding-top: 15px;}
	
	/* specific formatting for the settings form and table */
	#settings input {width: 6em;}
	#settings {margin-top: 20px; margin-bottom: 20px;}
	
	.myForm .title {font-size: 160%; font-weight: bold; margin: .3em auto .5em; text-align: center;}
	.myForm .subTitle {font-size: 120%; margin: 0 auto; text-align: center; margin-bottom: 1em;}
	.myForm.center{text-align: center;}
	.myForm .centerRow {margin: 1em 0;}
	
	#on-off input {width: 6em;}
	#on-off {margin-top: 20px; margin-bottom: 20px;}
	
	.tempMsg {display: none;}
	.tempMsg, .permMsg {color: red;}
	.errMsg {color: red; padding: 0 10px;}

</style>
</head>
<body>
{{> header}}

<form id="settings" class="two_column" action="/settings" method="post">
<table>
	<tbody>
		<tr class="fullRow">
			<th class="title" colspan="2">Control Settings</th>
		</tr>
		<tr>
			<td>Minimum Attic Temperature (&deg;F):</td>
			<td><input name="minTemp" value="{{minTemp}}"></td>
		</tr>
		<tr>
			<td>Temperature Difference Trigger (&deg;F):</td>
			<td><input name="deltaTemp" value="{{deltaTemp}}"></td>
		</tr>
		<tr>
			<td>Hysteresis Temperature Delta (&deg;F):</td>
			<td><input name="overshoot" value="{{overshoot}}"></td>
		</tr>
		<tr>
			<td>Wait Time Before Restart (mins):</td>
			<td><input name="waitTime" value="{{waitTime}}"></td>
		</tr>
		<tr>
			<td>Averaging Time Temperature Readings (mins):</td>
			<td><input name="outsideAveragingTime" value="{{outsideAveragingTime}}"></td></tr>
		<tr class="fullRow buttonRow">
			<td colspan="2"><button type="submit">Save</button></td>
		</tr>
		<tr class="fullRow tempMsg">
			<td colspan="2"><div class="msg"></div></td>
		</tr>
	</tbody>
</table>
</form>

<hr>
<form id="on-off" class="myForm center">
	<div class="title">Fan Control</div>
	<div class="subTitle">Control is currently set to: <span id="fanControlType">{{fanControl}}</span></div>
	<div class="centerRow">
		{{#if fanState}}
		<button id="turnFanOff" name="action" value="off">Turn Fan Off</button>
		<button id="turnFanOn" name="action" value="on" style="display: none;">Turn Fan On</button>
		{{else}}
		<button id="turnFanOff" name="action" value="off" style="display: none;">Turn Fan Off</button>
		<button id="turnFanOn" name="action" value="on">Turn Fan On</button>
		{{/if}}
		<label> And Resume Auto After: </label>
			<input name="fanControlReturnToAuto" value="{{fanControlReturnToAutoDefault}}" data-displayerrafter="fanControlReturnToAutoUnits"> 
			<select name="fanControlReturnToAutoUnits" id="fanControlReturnToAutoUnits"><option value="minutes" selected="selected">Minutes</option><option value="hours">Hours</option><option value="days">Days</option></select>
	</div>
	<div class="centerRow">
		<button id="turnFanAuto" name="action" value="auto" 
			{{#ifCond fanControl "==" "auto"}} style="display: none;" {{/ifCond}}>
			Set Fan to Auto</button>
	</div>
	<div class="tempMsg">
		<div class="msg"></div>
	</div>
</form>


<hr>
<div style="text-align: center">
	<p>Select the desired temperature units:</p>

	<input checked="checked" id="celsius" name="temperatureUnits" type="radio" value="C" /> 
	<label for="celsius">Celsius</label><br />
	<input id="fahrenheit" name="temperatureUnits" type="radio" value="F" /> 
	<label for="fahrenheit">Fahrenheit</label>
</div>	


<script>
// page initialization code
(function() {
	var temperatureUnits = $.cookie("temperatureUnits") || "C";
	if (temperatureUnits !== "C") {
		temperatureUnits = "F";
	}
	$("input[name='temperatureUnits']").change(function() {
		$.cookie("temperatureUnits", this.value, { expires: 365 * 10, path: '/' });
	}).filter("[value='" + temperatureUnits + "']").prop("checked", true);
	
	function clearErrors(root) {
		root = $(root);
		root.find(".errMsg").remove();
	}
	
	function showErrors(root, errObject) {
		root = $(root);
		// clean up old error messages
		clearErrors(root);
		for (var name in errObject) {
			var content = "<span class='errMsg'>" + errObject[name] + "</span>";
			var item = root.find("[name='" + name + "']").first();
			var item = getErrAfter(root, item);
			item.after(content);
		}
	}
	
	function getErrAfter(root, elem) {
		elem = $(elem);
		var displayAfter = elem.data("displayerrafter");
		if (displayAfter) {
			return root.find("[name='" + displayAfter + "']").first();
		}
		return elem;
	}
	
	function showTempMsg(selector, msg, t) {
		t = t || 10;
		$(selector).find(".tempMsg").show().find(".msg").html(msg).end().stop(true).delay(t * 1000).fadeOut(2000);
	}
	
	// hook up event handlers for the forms
	var settingsForm = $("#settings");
	settingsForm.find("input").on("input", function(e) {
		var item = getErrAfter(settingsForm, this);
		item.next(".errMsg").css("visibility", "hidden");
	});
	
	settingsForm.submit(function(e) {
		e.preventDefault();
		var self = this;
		$.post("/settings", $(this).serialize()).done(function(result) {
			clearErrors(settingsForm);
			// show settings saved message here
			if (result.status === "ok") {
				showTempMsg(settingsForm, "Settings Saved Successfully");
			} else {
				showErrors(self, result.err);
				showTempMsg(settingsForm, "Errors reported, settings not saved");
			}
		});
	});
	
	// on/off/auto form
	var onOffForm = $("#on-off");
	
	onOffForm.find("input").on("input", function(e) {
		// if we modify this entry, then remove any error message next to it
		var item = getErrAfter(onOffForm, this);
		item.next(".errMsg").css("visibility", "hidden");
	});
	
	onOffForm.submit(function(e) {
		// prevent normal form submission
		// require direct button click
		e.preventDefault();
	}).find("button").click(function(e) {
		e.preventDefault();
		// get form data plus the action
		var button = $(this);
		var action = button.attr("value");
		var form = button.closest("form");
		var data = form.serialize() + "&action=" + action;
		$.post("/onoff", data).done(function(result) {
			clearErrors(form);
			if (result.status === "ok") {
				showTempMsg("#on-off", "Fan set to " + action);
				$("#fanControlType").text(action);
				if (action === "auto") {
					$("#turnFanAuto").hide();
					// FIXME: we don't know whether to show the on or off buttons here
				} else if (action === "off") {
					$("#turnFanOff").hide();
					$("#turnFanOn").show();
				} else if (action === "on") {
					$("#turnFanOn").hide();
					$("#turnFanOff").show();
				}
				
			} else {
				showErrors(form, result.err);
				showTempMsg("#on-off", "Errors reported, settings not saved");
			}
		});
	});
})();
</script>
</body>
</html>